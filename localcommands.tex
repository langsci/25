% is done in langscibook
%\useshorthands*{"}\languageshorthands{ngerman}

\let\citew\citet


% requires amsmath for \text
\newcommand\mathdash{\text{\normalfont -}}


\newcommand{\todostefan}[1]{{\memoizeset{disable}\todo[color=orange!80]{\footnotesize #1}}\xspace}
\newcommand{\todosatz}[1]{{\memoizeset{disable}\todo[color=red!40]{\footnotesize #1}}\xspace}

\newcommand{\inlinetodostefan}[1]{{\memoizeset{disable}\todo[color=green!40,inline]{\footnotesize #1}}\xspace}



%% \newcommand{\remarkstefan}[1]{\todo[color=green!40]{\footnotesize #1}\xspace}
%% \newcommand{\remarkbjarne}[1]{\todo[color=red!40]{\footnotesize #1}\xspace}

%% \newcommand{\inlineremarkstefan}[1]{\todo[color=green!40,inline]{\footnotesize #1}\xspace}
%% \newcommand{\inlineremarkbjarne}[1]{\todo[color=red!40,inline]{\footnotesize #1}\xspace}

%\newcommand{\treeag}{TAG\indextag}

%% is done by package option 
\ifdraft
\proofmodetrue
\fi


%% % taken from covington.sty (check)
%% %\newcounter{lsptempcnt}

%% \newcommand{\mex}[1]{\setcounter{lsptempcnt}{\value{equation}}%
%% \addtocounter{lsptempcnt}{#1}%
%% \arabic{lsptempcnt}}%

%\displaywidowpenalty=10000\relax
%\predisplaypenalty=-200\relax


%\newcommand{\mod}{\textsc{mod}\xspace}  % wegen beamer.cls nicht in abbrev.sty

%\usepackage[figuresright]{rotating}


% http://tex.stackexchange.com/questions/203/how-to-obtain-verbatim-text-in-a-footnote
% somehow does not work
%\usepackage{fancyvrb}

%\newcommand{\tag}{TAG\indextag} % has to be here, conflict with latexbeamer

% mit der Index-Version geht die Silbentrennung nicht
\renewcommand{\word}[1]{\emph{#1}}

%\newcommand{\dom}{\textsc{dom}\xspace}

% changed to \textsc{part}
%\newcommand{\prt}{\textsc{prt}}
%\newcommand{\refl}{\textsc{refl}}
\newcommand{\rel}{\textsc{rel}\xspace}



%% \newcommand{\snom}{\textit{snom}}
%% \newcommand{\sgen}{\textit{sgen}}
%% \newcommand{\sacc}{\textit{sacc}}

%\usepackage{my-index-shortcuts}

\newcommand{\tes}{Tesnière\xspace}
\newcommand{\mel}{Mel'čuk\xspace}
%\newcommand{\dom}{\textsc{dom}\xspace}


\newcommand{\page}{}


\let\mc=\multicolumn


%\exewidth{\exnrfont (34)}
% should be set up for the whole series in langsci.cls
\renewcommand{\fnexfont}{\footnotesize\upshape}
%\let\oldglt\glt
%\def\glt{\oldglt\justify}
%\def\glt{\nopagebreak\vskip.17\baselineskip\transfont\parindent0ex}

\makeatletter
\def\ea{\ifnum\@xnumdepth=0\begin{exe}\else\begin{xlist}[iv.]\fi\ex}
\def\eal{\begin{exe}\exnrfont\ex\begin{xlist}[iv.]}

\def\gll%                  % Introduces 2-line text-and-gloss.
    {
%\raggedright%
        \bgroup
     \ifx\@gsingle1%           conditionally force single spacing (hpk/MC)
	 \def\baselinestretch{1}\@selfnt\fi
%        \vskip\baselineskip\def\baselinestretch{1}%
%        \@selfnt\vskip-\baselineskip\fi%
    \bgroup
    \twosent
   }
\makeatother


% to set the MRSes for scope underspecification
%http://tex.stackexchange.com/questions/218417/replacing-tree-dvips-connect-nodes-in-a-tabular-environment/218458#218458
\usepackage{tcolorbox}
\tcbuselibrary{skins}
% for texlive 2015
\newtcbox{\mybox}[1][]{empty,shrink tight,nobeforeafter,on line,before upper=\vphantom{gM},remember as=#1,top=2pt,bottom=2pt}

% for texlive 2013
%\newtcbox{\mybox}[1][]{enhanced,boxrule=0pt,colframe=white,colback=white,shrink tight,nobeforeafter,on line,before upper=\vphantom{gM},remember as=#1} %,top=3pt,bottom=3pt}
                                %use shorten <=2pt,shorten >=2pt in the pictures.

\newcommand{\mynode}[2]{\mybox[#1]{#2}}


% http://tex.stackexchange.com/questions/218417/replacing-tree-dvips-connect-nodes-in-a-tabular-environment/218458#218458
% Instead of using the package tikzmark, you can define your own \tikzmark being a regular node. There's no need to use tcolorbox package.
\newcommand{\mysubnode}[2]%
    {\tikz[baseline=(#1.base), remember picture]\node[outer sep=0pt, inner sep=0pt] (#1) {#2};}

% http://tex.stackexchange.com/questions/230300/doing-something-like-psframebox-in-tikz#230306
\tikzset{
frbox/.style={
  rounded corners,
  draw,
  thick,
  inner sep=5pt
  }
}
\newcommand\TZbox[1]{\tikz{\node[frbox,baseline] {#1};}}

\renewcommand{\rm}{\upshape}
\renewcommand{\mathrm}{\text}
\renewcommand{\it}{\itshape}
\renewcommand{\sc}{\scshape}
\renewcommand{\bf}{\bfseries}




% due to pdf readers facing page does not make sense:

%\def\reftextfaceafter{auf der \reftextvario{gegen\"uberliegenden}{n\"achsten} Seite}%
%\def\reftextfacebefore{auf der \reftextvario{gegen\"uberliegenden}{vorigen} Seite}%

\def\reftextfaceafter{on the following page}%
\def\reftextfacebefore{on the preceeding page}%



% needed for bibtex sorting. Usually provided from the bib file, but this fails for the first run.
\providecommand*{\donothing}[1]{}


% since all the theories are different, we start counting from scratch for every chapter.
% Thanks to Antonio MyP for pointing this out.

\makeatletter
\@addtoreset{principle}{chapter}
\@addtoreset{schema}{chapter}
\makeatother


% http://tex.stackexchange.com/questions/298031/is-it-possible-to-add-a-command-at-the-beginning-of-a-chapter?noredirect=1#
\pretocmd{\chapter}{% <--- IMPORTANT
    \exewidth{(34)}% <--- IMPORTANT
}{}{}


% The oridingal definition from cgloss4e.
% This is incompatible with \jambox, but does raggedright

%% \def\gllr%                 % Introduces 2-line text-and-gloss.
%%    {\begin{flushleft}
%%      \ifx\@gsingle1%           conditionally force single spacing (hpk/MC)
%%         \vskip\baselineskip\def\baselinestretch{1}%
%%         \@selfnt\vskip-\baselineskip\fi%
%%     \bgroup
%%     \twosentr
%%    }


%%    \gdef\twosentr#1\\ #2\\{% #1 = first line, #2 = second line
%%     \getwords(\lineone,\eachwordone)#1 \\%
%%     \getwords(\linetwo,\eachwordtwo)#2 \\%
%%     \loop\lastword{\eachwordone}{\lineone}{\wordone}%
%%          \lastword{\eachwordtwo}{\linetwo}{\wordtwo}%
%%          \global\setbox\gline=\hbox{\unhbox\gline
%%                                     \hskip\glossglue
%%                                     \vtop{\box\wordone   % vtop was vbox
%%                                           \nointerlineskip
%%                                           \box\wordtwo
%%                                          }%
%%                                    }%
%%          \testdone
%%          \ifnotdone
%%     \repeat
%%     \egroup % matches \bgroup in \gloss
%%    \gl@stop}


% http://tex.stackexchange.com/questions/297068/adding-coordinates-for-connection-between-nodes-in-several-forest-environments
%
% is required because the construction of the curves otherwise results in an enormous bounding box,
% which probably isn't what you want. To see what it does, just delete it from the tree and observe
% the results.

\makeatletter
\newcommand*\ignoreme{\pgf@relevantforpicturesizefalse}
\makeatother


% biblatex stuff
% get rid of initials for Carl J. Pollard and Carl Pollard in the main text:
% Müller is Müller, even if there is a G. Müller
\ExecuteBibliographyOptions{uniquename=false}

\ExecuteBibliographyOptions{mincrossrefs=99}


% Ash Template LFG

\newcommand{\featname}[1]{\mbox{\textsc{#1}}}    % feature name

\newcommand{\argzero}{\featname{arg$_0$}\xspace}
\renewcommand{\argone}{\featname{arg$_1$}\xspace}
\renewcommand{\argtwo}{\featname{arg$_2$}\xspace}
\renewcommand{\argthree}{\featname{arg$_3$}\xspace}

\newcommand{\templaten}[1]{\textsc{#1}}


% the distance between (i) and the example
%\gblabelsep{1em}



%https://tex.stackexchange.com/questions/11707/how-to-force-output-to-a-left-or-right-page
%% \newcommand*\cleartoleftpage{%
%%   \clearpage
%%   \ifodd\value{page}\hbox{}\newpage\fi
%% }



% https://tex.stackexchange.com/questions/95014/aligning-overline-to-italics-font/95079#95079
\newbox\usefulbox

\makeatletter
    \def\getslant #1{\strip@pt\fontdimen1 #1}

    \def\skoverline #1{\mathchoice
     {{\setbox\usefulbox=\hbox{$\m@th\displaystyle #1$}%
        \dimen@ \getslant\the\textfont\symletters \ht\usefulbox
        \divide\dimen@ \tw@ 
        \kern\dimen@ 
        \overline{\kern-\dimen@ \box\usefulbox\kern\dimen@ }\kern-\dimen@ }}
     {{\setbox\usefulbox=\hbox{$\m@th\textstyle #1$}%
        \dimen@ \getslant\the\textfont\symletters \ht\usefulbox
        \divide\dimen@ \tw@ 
        \kern\dimen@ 
        \overline{\kern-\dimen@ \box\usefulbox\kern\dimen@ }\kern-\dimen@ }}
     {{\setbox\usefulbox=\hbox{$\m@th\scriptstyle #1$}%
        \dimen@ \getslant\the\scriptfont\symletters \ht\usefulbox
        \divide\dimen@ \tw@ 
        \kern\dimen@ 
        \overline{\kern-\dimen@ \box\usefulbox\kern\dimen@ }\kern-\dimen@ }}
     {{\setbox\usefulbox=\hbox{$\m@th\scriptscriptstyle #1$}%
        \dimen@ \getslant\the\scriptscriptfont\symletters \ht\usefulbox
        \divide\dimen@ \tw@ 
        \kern\dimen@ 
        \overline{\kern-\dimen@ \box\usefulbox\kern\dimen@ }\kern-\dimen@ }}%
     {}}
    \makeatother


% Some notes on how these things work. Sometimes the boxes are not of same hight.
% Felix suggested to use vspace within the boxes to fix this:
% https://github.com/langsci/25/issues/42
% To fix this in a single frame, please use \vspace{n\baselineskip}, where n is a factor to be
% adjusted to the particular case. In the boxes in your screenshot, I'd guess that n=1. 

% Do you also want a more general solution? This kind of correction is probably best applied on a
% case-by-case basis, but I don't know the other boxes in your book. 

% largerpage in boxes?
%
% If the box spans only two pages, try to call \largerpage[n] before the box.
%
% You can also try more classical methods like \widowpenalty=10000 or \nopagebreak within the box.


% Is tcolorbox used as backend?
\ifbool{langsci@tbls@tcolorbox}{%
\newcommand{\questions}[1]{{\memoizeset{disable}%
\begin{tblsfilledsymbol}{Comprehension questions}{people}\setlist{leftmargin=*}#1\end{tblsfilledsymbol}}}
\newcommand{\exercises}[1]{{\memoizeset{disable}%
\begin{tblsfilledsymbol}{Exercises}{pencil}\setlist{leftmargin=*}#1\end{tblsfilledsymbol}}}
\newcommand{\furtherreading}[1]{{\memoizeset{disable}%
\begin{tblsfilledsymbol}{Further reading}{book}#1\end{tblsfilledsymbol}}}}{}

% Is mdframed used as backend?
\notbool{langsci@tbls@tcolorbox}{%
\newcommand{\questions}[1]{~\newline\vspace*{-10mm}
{\memoizeset{disable}%
\tblssy{people}{Comprehension questions}{\setlist{leftmargin=*}#1}}}
%\tblssy{people}{Comprehension questions}{#1}}

\newcommand{\exercises}[1]{{\memoizeset{disable}%
\tblssy{pencil}{Exercises}{\setlist{leftmargin=*}#1}}}
%\tblssy{pencil}{Exercises}{#1}}

\newcommand{\furtherreading}[1]{%~\newline\vspace*{-10mm}
{\memoizeset{disable}%
\tblssy{book}{Further reading}{#1}}}

\newcommand{\greyboxrest}[1]{
{\memoizeset{disable}%
\begin{mdframed}[style=greyexercisenologo]
#1
\end{mdframed}
}}

\mdfdefinestyle{greyexercisenologo}{%
	everyline=true,ignorelastdescenders=true,
	linewidth=0pt,backgroundcolor=\tblsboxcolor,
	innerleftmargin=5mm, innerrightmargin=5mm, innerbottommargin=5mm, innertopmargin=5mm,
	frametitleaboveskip=15mm, frametitlebelowskip=5mm,frametitlerule=false, repeatframetitle=false
}}{}


\robustify\textsc
\robustify\textit


% get rrid of these morewrite messages:
% https://tex.stackexchange.com/questions/419489/suppressing-messages-to-standard-output-from-package-morewrites/419494#419494
\ExplSyntaxOn
\cs_set_protected:Npn \__morewrites_shipout_ii:
  {
    \__morewrites_before_shipout:
    \__morewrites_tex_shipout:w \tex_box:D \g__morewrites_shipout_box
    \edef\tmp{\interactionmode\the\interactionmode\space}\batchmode\__morewrites_after_shipout:\tmp
  }
\ExplSyntaxOff

% https://tex.stackexchange.com/questions/154594/how-to-diagnose-a-permanent-labels-may-have-changed-warning
%% \makeatletter
%% \def\@testdef #1#2#3{%
%%   \def\reserved@a{#3}\expandafter \ifx \csname #1@#2\endcsname
%%  \reserved@a  \else
%% \typeout{^^Jlabel #2 changed:^^J%
%% \meaning\reserved@a^^J%
%% \expandafter\meaning\csname #1@#2\endcsname^^J}%
%% \@tempswatrue \fi}
%% \makeatother



% Felix Kopechky 16.08.2019
% Für die Lösung des van Trijp-Problems
% \patchcmd{\mkbibindexname}{\ifdefvoid{#3}{}{\MakeCapital{#3} }}{\ifdefvoid{#3}{}{#3 }}{}{\AtEndDocument{\typeout{mkbibindexname could not be patched.}}}

% I moved these definitions here (from 3-minimalism.tex) because of extraction of trees
\edef\innerxsep{\noexpand\hspace*{\pgfkeysvalueof{/pgf/inner xsep}}}%
\newlength\mytextheight
\settototalheight{\mytextheight}{XpX$^0$X$'$}



% Felix 09.06.2020: copy code from the third line into localcommands.tex: https://github.com/langsci/langscibook#defined-environments-commands-etc
\patchcmd{\mkbibindexname}{\ifdefvoid{#3}{}{\MakeCapital{#3} }}{\ifdefvoid{#3}{}{#3 }}{}{\AtEndDocument{\typeout{mkbibindexname could not be patched.}}}
